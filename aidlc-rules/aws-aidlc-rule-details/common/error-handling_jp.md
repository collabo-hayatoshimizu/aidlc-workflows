# エラー処理とリカバリ手順

## 一般的なエラー処理の原則

### エラーが発生した場合
1. **エラーを特定**：何が問題だったかを明確に述べる
2. **影響を評価**：エラーがブロッキングか、回避できるかを判断
3. **コミュニケーション**：エラーとオプションについてユーザーに通知
4. **解決策を提供**：解決または回避するための明確なステップを提供
5. **文書化**：エラーと解決を`audit.md`に記録

### エラーの重大度レベル

**Critical（重大）**：ワークフローを続行できない
- 必要なファイルまたは成果物が欠落
- 処理できない無効なユーザー入力
- ファイル操作を妨げるシステムエラー

**High（高）**：フェーズが計画通りに完了できない
- 必須の質問に対する不完全な回答
- 矛盾するユーザー応答
- 以前のフェーズからの依存関係が欠落

**Medium（中）**：回避策でフェーズを続行できる
- オプションの成果物が欠落
- 重要でない検証の失敗
- 部分的な完了が可能

**Low（低）**：進捗をブロックしない軽微な問題
- フォーマットの不整合
- オプション情報が欠落
- ブロッキングしない警告

## フェーズ固有のエラー処理

### コンテキスト評価のエラー

**エラー**：ワークスペースファイルを読み取れない
- **原因**：権限の問題、ディレクトリの欠落
- **解決策**：ユーザーにワークスペースパスと権限を確認するよう依頼
- **回避策**：ユーザー提供の情報のみで進行

**エラー**：既存の`aidlc-state.md`が破損している
- **原因**：手動編集、不完全な以前の実行
- **解決策**：ユーザーに新規開始または復旧の試行を希望するか尋ねる
- **復旧**：バックアップを作成し、新しいステートファイルを開始

**エラー**：必要なフェーズを決定できない
- **原因**：ユーザーからの情報が不十分
- **解決策**：意図とスコープについて明確化の質問をする
- **回避策**：包括的な実行計画をデフォルトに

### 要件評価のエラー

**エラー**：ユーザーが矛盾する要件を提供
- **原因**：理解が不明確、ニーズの変化
- **解決策**：矛盾を解決するためのフォローアップ質問を作成
- **進行しない**：矛盾が解決されるまで

**エラー**：要件ドキュメントを変換できない
- **原因**：サポートされていない形式、破損したファイル
- **解決策**：ユーザーにサポートされている形式で要件を提供するよう依頼
- **回避策**：ユーザーの口頭説明で作業

**エラー**：検証質問への不完全な回答
- **原因**：ユーザーが質問をスキップ、何を答えるべきか不明確
- **解決策**：未回答の質問を強調し、例を提供
- **進行しない**：必須の質問すべてに回答されるまで

### ストーリー開発のエラー

**エラー**：要件をストーリーにマッピングできない
- **原因**：要件が曖昧すぎる、機能的な詳細が欠落
- **解決策**：明確化のために要件評価に戻る
- **回避策**：利用可能な情報に基づいてストーリーを作成し、不完全とマーク

**エラー**：ユーザーが曖昧なストーリー計画の回答を提供
- **原因**：オプションが不明確、決定が複雑
- **解決策**：具体的な例を含むフォローアップ質問を追加
- **進行しない**：曖昧さが解決されるまで

**エラー**：ストーリー生成計画に未完了のステップがある
- **原因**：実行が中断された、ステップがスキップされた
- **解決策**：最初の未完了ステップから再開
- **復旧**：完了したステップを確認し、チェックポイントから続行

### アプリケーション設計のエラー

**エラー**：アーキテクチャ決定が不明確または矛盾している
- **原因**：曖昧な回答、矛盾する要件
- **解決策**：決定を明確にするためのフォローアップ質問を追加
- **進行しない**：決定が明確で文書化されるまで

**エラー**：サービス/ユニットの数を決定できない
- **原因**：境界に関する情報が不十分
- **解決策**：デプロイメント、チーム構造、スケーリングについて具体的な質問をする
- **回避策**：モノリスをデフォルトにし、後で変更を許可

### 設計のエラー

**エラー**：ユニットの依存関係が循環している
- **原因**：境界定義が不適切、密結合
- **解決策**：循環依存関係を特定し、リファクタリングを提案
- **復旧**：サイクルを壊すためにユニット境界を修正

**エラー**：ユニット設計計画にステップが欠落している
- **原因**：計画生成が不完全、テンプレートエラー
- **解決策**：必要なすべてのステップを含む計画を再生成
- **復旧**：既存の計画に欠落しているステップを追加

**エラー**：設計成果物を生成できない
- **原因**：ユニット情報が欠落、要件が不明確
- **解決策**：ユニット定義を明確にするためにユニット計画に戻る
- **回避策**：部分的な設計を生成し、ギャップをマーク

### NFR実装のエラー

**エラー**：テクノロジースタックの選択に互換性がない
- **原因**：矛盾する要件、プラットフォームの制限
- **解決策**：非互換性を強調し、ユーザーに選択を依頼
- **進行しない**：互換性のある選択がなされるまで

**エラー**：組織的な制約を満たせない
- **原因**：ネットワーク制限、セキュリティポリシー
- **解決策**：制約を文書化し、ユーザーに回避策を尋ねる
- **エスカレーション**：セットアップのために人間の介入が必要な場合がある

**エラー**：NFR実装ステップに人間の行動が必要
- **原因**：AIが特定のタスク（ネットワーク設定、認証情報）を実行できない
- **解決策**：明確に**HUMAN TASK**としてマークし、指示を提供
- **待機**：進行する前にユーザーの確認を待つ

### コード計画のエラー

**エラー**：コード生成計画が不完全
- **原因**：設計成果物が欠落、要件が不明確
- **解決策**：成果物を完成させるために設計フェーズに戻る
- **復旧**：利用可能な情報で計画を生成し、ギャップをマーク

**エラー**：ユニットの依存関係が満たされていない
- **原因**：依存するユニットがまだ生成されていない
- **解決策**：依存関係を尊重するように生成シーケンスを並べ替える
- **回避策**：スタブ依存関係で生成し、後で統合

### コード生成のエラー

**エラー**：ステップのコードを生成できない
- **原因**：設計情報が不十分、要件が不明確
- **解決策**：ステップをスキップし、不完全として文書化し、続行
- **復旧**：より多くの情報を収集した後にステップに戻る

**エラー**：生成されたコードに構文エラーがある
- **原因**：テンプレートの問題、言語固有の問題
- **解決策**：構文エラーを修正し、必要に応じて再生成
- **検証**：進行する前にコードがコンパイルされることを確認

**エラー**：テスト生成が失敗
- **原因**：ロジックが複雑、テストフレームワークのセットアップが欠落
- **解決策**：基本的なテスト構造を生成し、手動完了のためにマーク
- **回避策**：テストなしで進行し、運用フェーズで追加

### 運用のエラー

**エラー**：ビルドツールを決定できない
- **原因**：異常なプロジェクト構造、複数のビルドシステム
- **解決策**：ユーザーにビルドツールとコマンドを指定するよう依頼
- **回避策**：一般的な指示を提供し、ユーザーが適応

**エラー**：デプロイメントターゲットが不明確
- **原因**：複数の環境、複雑なインフラストラクチャ
- **解決策**：ユーザーにデプロイメントターゲットと方法を指定するよう依頼
- **回避策**：一般的なプラットフォームの指示を提供

## リカバリ手順

### 部分的なフェーズ完了

**シナリオ**：フェーズが実行中に中断された

**リカバリステップ**：
1. フェーズ計画ファイルを読み込む
2. 最後に完了したステップを特定（最後の[x]チェックボックス）
3. 次の未完了ステップから再開
4. すべての以前のステップが実際に完了していることを確認
5. 通常の実行を続行

### 破損したステートファイル

**シナリオ**：`aidlc-state.md`が破損または不整合

**リカバリステップ**：
1. バックアップを作成：`aidlc-state.md.backup`
2. ユーザーに実際にどのフェーズにいるか尋ねる
3. ゼロからステートファイルを再生成
4. 既存の成果物に基づいて完了したフェーズをマーク
5. 現在のフェーズから再開

### 成果物の欠落

**シナリオ**：以前のフェーズの必要な成果物が欠落

**リカバリステップ**：
1. どの成果物が欠落しているかを特定
2. それらを再生成できるかどうかを判断
3. はいの場合：そのフェーズに戻り、成果物を再生成
4. いいえの場合：ユーザーに手動で情報を提供するよう依頼
5. `audit.md`にギャップを文書化

### ユーザーがフェーズを再開したい

**シナリオ**：ユーザーがフェーズの結果に満足せず、やり直したい

**リカバリステップ**：
1. ユーザーが再開を希望することを確認（データは失われる）
2. 既存の成果物をアーカイブ：`{artifact}.backup`
3. `aidlc-state.md`でフェーズのステータスをリセット
4. 計画ファイルのフェーズチェックボックスをクリア
5. 最初からフェーズを再実行

### ユーザーがフェーズをスキップしたい

**シナリオ**：ユーザーが計画されていたフェーズをスキップしたい

**リカバリステップ**：
1. ユーザーが影響を理解していることを確認
2. `audit.md`にスキップ理由を文書化
3. `aidlc-state.md`でフェーズを「SKIPPED」としてマーク
4. 次のフェーズに進む
5. 注意：依存関係が欠落している場合、後のフェーズで問題が発生する可能性がある

## エスカレーションガイドライン

### ユーザーの助けを求めるタイミング

**即座に**：
- 矛盾または曖昧なユーザー入力
- 必要な情報が欠落
- AIが解決できない技術的制約
- ビジネス判断を必要とする決定

**解決を試みた後**：
- 同じステップでの繰り返しエラー
- 複雑な技術的問題
- 異常なプロジェクト構造
- 外部システムとの統合

### やり直しを提案するタイミング

**次の場合は新規開始を検討**：
- 複数のフェーズにエラーがある
- ステートファイルが深刻に破損している
- ユーザーが欠落している情報を提供できない
- 成果物がフェーズ間で一貫性がない

## セッション再開のエラー

### 再開時の成果物の欠落

**エラー**：以前のステージからの必要な成果物が欠落
- **原因**：ファイルが削除、移動、または作成されなかった
- **解決策**：
  1. どのステージが欠落している成果物を作成したかを特定
  2. aidlc-state.mdでステージが完了とマークされているか確認
  3. 完了とマークされているが成果物が欠落している場合：そのステージを再生成
  4. 完了とマークされていない場合：そのステージから再開
- **復旧**：欠落している成果物を作成するステージに戻り、再実行

**エラー**：成果物ファイルが存在するが空または破損している
- **原因**：書き込みが中断された、手動編集、ファイルシステムの問題
- **解決策**：
  1. 破損したファイルのバックアップを作成
  2. それを作成するステージから再生成を試みる
  3. 再生成できない場合：ユーザーに再作成するための情報を尋ねる
- **復旧**：成果物を作成するステージを再実行

### 再開時の不整合な状態

**エラー**：aidlc-state.mdがステージを完了と表示しているが、成果物が存在しない
- **原因**：ステートファイルが更新されたが、成果物生成が失敗した
- **解決策**：
  1. aidlc-state.mdでステージを不完全としてマーク
  2. 成果物を生成するためにステージを再実行
  3. 完了とマークする前に成果物が存在することを確認
- **復旧**：ステージのステータスをリセットして再実行

**エラー**：成果物は存在するが、aidlc-state.mdがステージを不完全と表示
- **原因**：成果物生成が成功したが、状態更新が失敗した
- **解決策**：
  1. 成果物が完全で有効であることを確認
  2. aidlc-state.mdを更新してステージを完了とマーク
  3. 次のステージに進む
- **復旧**：実際の完了を反映するように状態ファイルを更新

**エラー**：aidlc-state.mdで複数のステージが「現在」としてマークされている
- **原因**：状態ファイルの破損、手動編集
- **解決策**：
  1. 成果物を確認して実際の進捗を判断
  2. ユーザーに実際にどのステージにいるか尋ねる
  3. aidlc-state.mdを修正して単一の現在のステージを表示
- **復旧**：既存の成果物に基づいて状態ファイルを再構築

### コンテキスト読み込みエラー

**エラー**：以前のステージからの必要なコンテキストを読み込めない
- **原因**：ファイルの欠落、破損したコンテンツ、誤ったファイルパス
- **解決策**：
  1. 現在のステージに必要な成果物をリスト
  2. どれが欠落または破損しているかを確認
  3. 欠落している成果物を再生成するか、ユーザーに情報を尋ねる
- **復旧**：現在のステージを再開する前に前提条件のステージを完了

**エラー**：読み込まれた成果物に矛盾する情報が含まれている
- **原因**：手動編集、複数の人が作業、不完全な更新
- **解決策**：
  1. 矛盾を特定してユーザーに提示
  2. ユーザーにどの情報が正しいか尋ねる
  3. 矛盾を解決するために成果物を更新
- **復旧**：進行する前に矛盾を調整

### 再開のベストプラクティス

1. **常に状態を検証**：aidlc-state.mdが実際の成果物と一致することを確認
2. **段階的に読み込む**：成果物をステージごとに読み込み、それぞれを検証
3. **早期に失敗**：重要な成果物が欠落している場合は即座に停止
4. **明確にコミュニケーション**：何が欠落していて、なぜ必要かをユーザーに正確に伝える
5. **オプションを提供**：再生成、手動提供、または新規開始
6. **復旧を文書化**：すべての復旧アクションをaudit.mdに記録

## 予防のベストプラクティス

1. **早期に検証**：作業を開始する前に入力と依存関係をチェック
2. **頻繁にチェックポイント**：ステップを完了した直後にチェックボックスを更新
3. **明確にコミュニケーション**：何をしているか、なぜしているかを説明
4. **質問をする**：推測しない - 曖昧さを即座に明確にする
5. **すべてを文書化**：すべての決定と変更を`audit.md`に記録
