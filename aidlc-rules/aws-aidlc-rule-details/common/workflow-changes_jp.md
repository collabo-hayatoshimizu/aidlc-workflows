# ワークフロー中の変更とフェーズ管理

## 概要

ユーザーは、ワークフロー中に実行計画またはフェーズ実行の変更を要求する場合があります。このドキュメントは、これらの要求を安全かつ効果的に処理するためのガイダンスを提供します。

---

## ワークフロー中の変更のタイプ

### 1. スキップされたフェーズの追加

**シナリオ**：ユーザーが元々スキップされたフェーズを追加したい

**例**：「実際には、そのステージをスキップしましたが、ユーザーストーリーを追加したいです」

**処理**：
1. **要求を確認**：「ユーザーストーリーステージを追加したいとのことです。これによりユーザーストーリーとペルソナが作成されます。確認しますか？」
2. **依存関係をチェック**：すべての前提条件フェーズが完了していることを確認
3. **実行計画を更新**：`execution-plan.md`に理由を付けてフェーズを追加
4. **状態を更新**：`aidlc-state.md`でフェーズを「PENDING」としてマーク
5. **フェーズを実行**：通常のフェーズ実行プロセスに従う
6. **変更を記録**：タイムスタンプと理由を付けて`audit.md`に文書化

**考慮事項**：
- 新しい成果物から利益を得る可能性のある後のフェーズを更新する必要がある場合がある
- 既存の成果物を新しい情報を組み込むために修正する必要がある場合がある
- タイムラインが延長される

---

### 2. 計画されたフェーズのスキップ

**シナリオ**：ユーザーが実行する予定だったフェーズをスキップしたい

**例**：「今のところNFR設計ステージをスキップしましょう」

**処理**：
1. **要求を確認**：「NFR設計をスキップしたいとのことです。これはNFRパターンや論理コンポーネントが組み込まれないことを意味します。確認しますか？」
2. **影響について警告**：何が欠落し、潜在的な結果は何かを説明
3. **明示的な確認を取得**：ユーザーは影響の理解を明示的に確認する必要がある
4. **実行計画を更新**：理由を付けてフェーズを「SKIPPED」としてマーク
5. **状態を更新**：`aidlc-state.md`でフェーズを「SKIPPED」としてマーク
6. **後のフェーズを調整**：後のフェーズで手動セットアップが必要になる可能性があることを注記
7. **変更を記録**：タイムスタンプと理由を付けて`audit.md`に文書化

**考慮事項**：
- 後のフェーズが失敗したり、手動介入が必要になる場合がある
- ユーザーは欠落している成果物の責任を受け入れる
- 必要に応じて後で追加し直すことができる

---

### 3. 現在のステージの再開

**シナリオ**：ユーザーが現在のステージの結果に満足せず、やり直したい

**例**：「これらのユーザーストーリーは気に入りません。最初からやり直せますか？」

**処理**：
1. **懸念を理解**：「ストーリーのどの部分を具体的に変更したいですか？」
2. **オプションを提供**：
   - **オプションA**：既存の成果物を変更（より速く、一部の作業を保持）
   - **オプションB**：完全な再開（クリーンスレート、より多くの時間）
3. **再開が選択された場合**：
   - 既存の成果物をアーカイブ：`{artifact}.backup.{timestamp}`
   - 計画ファイルのステージチェックボックスをリセット
   - `aidlc-state.md`でステージを「IN PROGRESS」としてマーク
   - ステージ完了ステータスをクリア
   - 最初から再実行
4. **変更を記録**：再開の理由と何が変わるかを文書化

**考慮事項**：
- 既存の作業は失われる（ただしバックアップされる）
- 依存するステージをやり直す必要がある場合がある
- タイムラインが延長される

---

### 4. 以前のステージの再開

**シナリオ**：ユーザーが完了したステージを戻ってやり直したい

**例**：「以前に行ったアーキテクチャ決定を変更したいです」

**処理**：
1. **影響を評価**：再開するステージに依存するすべてのステージを特定
2. **ユーザーに警告**：「アプリケーション設計を再開すると、以下をやり直す必要があります：ユニット計画、ユニット生成、ユニットごとの設計（すべてのユニット）、コード計画、コード生成。確認しますか？」
3. **明示的な確認を取得**：ユーザーは完全な影響を理解する必要がある
4. **確認された場合**：
   - 影響を受けるすべての成果物をアーカイブ
   - `aidlc-state.md`で影響を受けるすべてのステージをリセット
   - 影響を受けるすべての計画ファイルのチェックボックスをクリア
   - 再開するステージに戻る
   - その時点から前進して再実行
5. **変更を記録**：完全な影響と再開の理由を文書化

**考慮事項**：
- 重要な再作業が必要
- すべての依存するステージをやり直す必要がある
- タイムラインが大幅に延長される
- 変更が再開よりも良いかどうかを検討

---

### 5. ステージの深度の変更

**シナリオ**：ユーザーが現在または今後のステージの深度レベルを変更したい

**例**：「標準ではなく包括的な要件分析を行いましょう」

**処理**：
1. **要求を確認**：「要件分析を標準から包括的な深度に変更したいとのことです。これはより徹底的ですが、時間がかかります。確認しますか？」
2. **実行計画を更新**：`workflow-planning.md`で深度レベルを変更
3. **アプローチを調整**：ステージの包括的な深度ガイドラインに従う
4. **見積もりを更新**：ユーザーに新しいタイムライン見積もりを通知
5. **変更を記録**：深度変更と理由を文書化

**考慮事項**：
- より深い深度=より多くの時間だが、より良い品質
- より少ない深度=より速いが、詳細を見逃す可能性がある
- ステージの前または中にのみ変更可能、完了後は不可

---

### 6. ワークフローの一時停止

**シナリオ**：ユーザーが一時停止して後で再開する必要がある

**例**：「今は停止して、明日続ける必要があります」

**処理**：
1. **現在のステップを完了**：可能であれば進行中の現在のステップを完了
2. **チェックボックスを更新**：完了したすべてのステップに[x]をマーク
3. **状態を更新**：`aidlc-state.md`が現在のステータスを反映していることを確認
4. **一時停止を記録**：`audit.md`に一時停止ポイントを文書化
5. **再開指示を提供**：「戻ってきたら、既存のプロジェクトを検出して、次から続けることを提案します：[現在のフェーズ、現在のステップ]」

**再開時**：
1. **既存のプロジェクトを検出**：`aidlc-state.md`をチェック
2. **コンテキストを読み込む**：完了したステージからすべての成果物を読み取る
3. **ステータスを表示**：現在のステージと次のステップを表示
4. **オプションを提供**：中断したところから続けるか、以前の作業を確認
5. **再開を記録**：`audit.md`に再開ポイントを文書化

---

### 7. アーキテクチャ決定の変更

**シナリオ**：ユーザーがモノリスからマイクロサービスに変更したい（またはその逆）

**例**：「実際には、モノリスの代わりにマイクロサービスを行いましょう」

**処理**：
1. **現在の進捗を評価**：ワークフローのどこまで進んでいるかを判断
2. **影響を説明**：
   - ユニット計画の前：最小限の影響、決定を更新するだけ
   - ユニット計画の後：ユニット計画、ユニット生成、すべてのユニットごとの設計をやり直す必要がある
   - コード生成の後：重要な再作業が必要
3. **アプローチを推奨**：
   - ワークフローの初期：アプリケーション設計ステージから再開
   - ワークフローの後期：変更が再開対実現可能かどうかを検討
4. **確認を取得**：ユーザーは変更の完全なスコープを理解する必要がある
5. **変更を実行**：影響を受けるステージの再開手順に従う

**考慮事項**：
- アーキテクチャの変更は連鎖的な影響がある
- ワークフローの初期=変更しやすい
- ワークフローの後期=コスト対利益を検討

---

### 8. ユニットの追加/削除

**シナリオ**：ユーザーがユニット生成後にユニットを追加または削除したい

**例**：「支払いユニットを支払いと請求に分割する必要があります」

**処理**：
1. **影響を評価**：どのユニットが設計/コードを完了したかを判断
2. **結果を説明**：
   - ユニットの追加：新しいユニットの完全な設計とコードが必要
   - ユニットの削除：機能を他のユニットに再配分する必要がある
   - ユニットの分割：結果として生じる両方のユニットの設計とコードをやり直す必要がある
3. **ユニット成果物を更新**：
   - `unit-of-work.md`を変更
   - `unit-of-work-dependency.md`を更新
   - `unit-of-work-story-map.md`を修正
4. **影響を受けるユニットをリセット**：影響を受けるユニットを再設計が必要としてマーク
5. **変更を実行**：影響を受けるユニットの通常のユニット設計とコードプロセスに従う

**考慮事項**：
- それらのユニットのすべての下流ステージに影響
- 依存関係が変更された場合、他のユニットに影響する可能性がある
- タイムライン影響は影響を受けるユニットの数に依存

---

## 変更を処理するための一般的なガイドライン

### 変更を行う前に

1. **要求を理解**：ユーザーが何を変更したいか、なぜ変更したいかについて明確化の質問をする
2. **影響を評価**：影響を受けるすべてのステージ、成果物、依存関係を特定
3. **結果を説明**：何をやり直す必要があるか、タイムラインへの影響を明確に伝える
4. **代替案を提供**：変更が再開よりも良い場合がある
5. **明示的な確認を取得**：ユーザーは影響を理解して受け入れる必要がある

### 変更中

1. **既存の作業をアーカイブ**：破壊的な変更を行う前に常にバックアップ
2. **すべての追跡を更新**：`aidlc-state.md`、計画ファイル、`audit.md`を同期させる
3. **進捗を伝える**：何が起こっているかについてユーザーに通知し続ける
4. **変更を検証**：変更がすべての成果物間で一貫していることを確認
5. **継続性をテスト**：変更後にワークフローがスムーズに続行できることを確認

### 変更後

1. **一貫性を確認**：すべての成果物が変更と整合していることをチェック
2. **ドキュメントを更新**：すべての参照が更新されていることを確認
3. **完全に記録**：`audit.md`に完全な変更履歴を文書化
4. **ユーザーと確認**：変更がユーザーの期待に合っているか確認
5. **ワークフローを再開**：新しい状態から通常の実行を続ける

---

## 変更要求決定ツリー

```
ユーザーが変更を要求
    |
    ├─ 現在のフェーズか？
    |   ├─ はい：現在のフェーズを変更または再開可能
    |   └─ いいえ：次の質問に移る
    |
    ├─ 完了したフェーズか？
    |   ├─ はい：依存するフェーズへの影響を評価
    |   |   ├─ 低影響：変更して依存するものを更新
    |   |   └─ 高影響：そのフェーズから再開を推奨
    |   └─ いいえ：次の質問に移る
    |
    ├─ スキップされたフェーズを追加するか？
    |   ├─ はい：前提条件をチェックし、計画に追加し、実行
    |   └─ いいえ：次の質問に移る
    |
    ├─ 計画されたフェーズをスキップするか？
    |   ├─ はい：影響について警告し、確認を取得し、スキップ
    |   └─ いいえ：次の質問に移る
    |
    └─ 深度レベルを変更するか？
        ├─ はい：計画を更新し、アプローチを調整
        └─ いいえ：ユーザーと要求を明確化

```

---

## ログ記録要件

### 変更要求ログ形式

```markdown
## 変更要求 - [フェーズ名]
**タイムスタンプ**：[ISOタイムスタンプ]
**要求**：[ユーザーが変更したいこと]
**現在の状態**：[ワークフローのどこにいるか]
**影響評価**：[何が影響を受けるか]
**ユーザー確認**：[ユーザーの明示的な確認]
**実行されたアクション**：[何が行われたか]
**影響を受けた成果物**：[変更/リセットされたファイルのリスト]

---
```

---

## ベストプラクティス

1. **常に確認**：明示的なユーザー確認なしに破壊的な変更を行わない
2. **影響を説明**：ユーザーは決定する前に結果を理解する必要がある
3. **オプションを提供**：変更を処理する方法が複数ある場合がある
4. **最初にアーカイブ**：破壊的な変更を行う前に常にバックアップ
5. **すべてを更新**：すべての追跡ファイルを同期させる
6. **徹底的に記録**：監査証跡のためにすべての変更を文書化
7. **後で検証**：ワークフローがスムーズに続行できることを確認
8. **柔軟に**：ワークフローは硬直したプロセスを強制するのではなく、ユーザーのニーズに適応すべき
