# コンテンツ検証ルール

## 必須：ファイル作成前のコンテンツ検証

**重要**：すべての生成コンテンツは、解析エラーを防ぐためにファイルに書き込む前に検証する必要があります。

## ASCII図の標準

**重要**：ASCII図を含むファイルを作成する前に：

1. **読み込み**：`common/ascii-diagram-standards.md`を読み込む
2. **検証**：各図を検証：
   - 行ごとの文字数をカウント（すべての行が同じ幅でなければならない）
   - 次のもののみを使用：`+` `-` `|` `^` `v` `<` `>` およびスペース
   - Unicodeボックス描画文字は使用しない
   - スペースのみ（タブは使用しない）
3. **テスト**：ボックスの角が垂直に揃っていることを確認して整列をテスト

**パターンと検証チェックリストについては、`common/ascii-diagram-standards.md`を参照してください。**

## Mermaid図の検証

### 必要な検証ステップ
1. **構文チェック**：ファイル作成前にMermaid構文を検証
2. **文字エスケープ**：特殊文字が適切にエスケープされていることを確認
3. **フォールバックコンテンツ**：Mermaidが検証に失敗した場合はテキスト代替を提供

### Mermaid検証ルール
```markdown
## Mermaid図を含むファイルを作成する前に：

1. ノードIDの無効な文字をチェック（英数字+アンダースコアのみを使用）
2. ラベル内の特殊文字をエスケープ：" → \" および ' → \'
3. フローチャート構文を検証：ノード接続は有効でなければならない
4. 簡単な検証で図の解析をテスト

## フォールバック：Mermaid検証が失敗した場合は、テキストベースのワークフロー表現を使用
```

### 実装パターン
```markdown
## ワークフロー視覚化

### Mermaid図（構文が有効な場合）
```mermaid
[検証された図のコンテンツ]
```

### テキスト代替（常に含める）
```
Phase 1: INCEPTION
- Stage 1: Workspace Detection (COMPLETED)
- Stage 2: Requirements Analysis (COMPLETED)
[テキスト表現を続ける]
```

## 一般的なコンテンツ検証

### 作成前の検証チェックリスト
- [ ] 埋め込みコードブロック（Mermaid、JSON、YAML）を検証
- [ ] 特殊文字のエスケープをチェック
- [ ] Markdown構文の正確性を確認
- [ ] コンテンツ解析の互換性をテスト
- [ ] 複雑な要素のフォールバックコンテンツを含める

### エラー防止ルール
1. **ファイルに書き込むためにツール/コマンドを使用する前に常に検証**：検証されていないコンテンツを書き込まない
2. **特殊文字をエスケープ**：特に図とコードブロック内
3. **代替案を提供**：視覚コンテンツのテキストバージョンを含める
4. **構文をテスト**：複雑なコンテンツ構造を検証

## 検証失敗の処理

### 検証が失敗した場合
1. **エラーをログ記録**：何が検証に失敗したかを記録
2. **フォールバックコンテンツを使用**：テキストベースの代替に切り替え
3. **ワークフローを続行**：コンテンツ検証の失敗でブロックしない
4. **ユーザーに通知**：解析の制約により簡略化されたコンテンツが使用されたことを伝える
