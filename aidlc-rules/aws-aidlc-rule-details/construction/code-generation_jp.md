# コード生成 - 詳細ステップ

## 概要
このステージは、2つの統合されたパートを通じて各作業単位のコードを生成します：
- **パート1 - 計画**：明示的なステップを含む詳細なコード生成計画を作成
- **パート2 - 生成**：承認された計画を実行してコード、テスト、成果物を生成

**注意**：ブラウンフィールドプロジェクトの場合、「生成」とは適切な場合に既存のファイルを変更することを意味し、重複を作成することではありません。

## 前提条件
- ユニットのユニット設計生成が完了している必要がある
- ユニットのNFR実装（実行された場合）が完了している必要がある
- すべてのユニット設計成果物が利用可能である必要がある
- ユニットがコード生成の準備ができている

---

# パート1：計画

## ステップ1：ユニットコンテキストを分析
- [ ] ユニット設計生成からユニット設計成果物を読み取る
- [ ] 割り当てられたストーリーを理解するためにユニットストーリーマップを読み取る
- [ ] ユニットの依存関係とインターフェースを識別
- [ ] ユニットがコード生成の準備ができていることを検証

## ステップ2：詳細なユニットコード生成計画を作成
- [ ] `aidlc-docs/aidlc-state.md`からワークスペースルートとプロジェクトタイプを読み取る
- [ ] コードの場所を決定（構造パターンについては重要なルールを参照）
- [ ] **ブラウンフィールドのみ**：変更する既存のファイルのためにリバースエンジニアリングcode-structure.mdを確認
- [ ] 正確なパスを文書化（決してaidlc-docs/ではない）
- [ ] ユニット生成のための明示的なステップを作成：
  - プロジェクト構造のセットアップ（グリーンフィールドのみ）
  - ビジネスロジック生成
  - ビジネスロジックユニットテスト
  - ビジネスロジックサマリー
  - API層生成
  - API層ユニットテスト
  - API層サマリー
  - リポジトリ層生成
  - リポジトリ層ユニットテスト
  - リポジトリ層サマリー
  - データベース移行スクリプト（データモデルが存在する場合）
  - ドキュメント生成（APIドキュメント、README更新）
  - デプロイメント成果物生成
- [ ] 各ステップに順番に番号を付ける
- [ ] ストーリーマッピング参照を含める
- [ ] 各ステップにチェックボックス[ ]を追加

## ステップ3：ユニット生成コンテキストを含める
- [ ] このユニットについて、以下を含める：
  - このユニットによって実装されるストーリー
  - 他のユニット/サービスへの依存関係
  - 期待されるインターフェースと契約
  - このユニットが所有するデータベースエンティティ
  - サービスの境界と責任

## ステップ4：ユニット計画ドキュメントを作成
- [ ] 完全な計画を`aidlc-docs/construction/plans/{unit-name}-code-generation-plan.md`として保存
- [ ] ステップ番号を含める（ステップ1、ステップ2など）
- [ ] ユニットのコンテキストと依存関係を含める
- [ ] ストーリーのトレーサビリティを含める
- [ ] 計画がステップバイステップで実行可能であることを確認
- [ ] この計画がコード生成の唯一の真実の源泉であることを強調

## ステップ5：ユニット計画を要約
- [ ] ユーザーにユニットコード生成計画のサマリーを提供
- [ ] ユニット生成アプローチを強調
- [ ] ステップシーケンスとストーリーカバレッジを説明
- [ ] ステップの合計数と見積もりスコープを注記

## ステップ6：承認プロンプトを記録
- [ ] 承認を求める前に、タイムスタンプ付きで`aidlc-docs/audit.md`にプロンプトを記録
- [ ] 完全なユニットコード生成計画への参照を含める
- [ ] ISO 8601タイムスタンプ形式を使用

## ステップ7：明示的な承認を待つ
- [ ] ユーザーがユニットコード生成計画を明示的に承認するまで進まない
- [ ] 承認は計画全体と生成シーケンスをカバーする必要がある
- [ ] ユーザーが変更を要求した場合は、計画を更新して承認プロセスを繰り返す

## ステップ8：承認応答を記録
- [ ] タイムスタンプ付きでユーザーの承認応答を`aidlc-docs/audit.md`に記録
- [ ] 正確なユーザー応答テキストを含める
- [ ] 承認ステータスを明確にマーク

## ステップ9：進捗を更新
- [ ] `aidlc-state.md`でコード計画を完了としてマーク
- [ ] 「現在のステータス」セクションを更新
- [ ] コード生成への移行を準備

---

# パート2：生成

## ステップ10：ユニットコード生成計画を読み込む
- [ ] `aidlc-docs/construction/plans/{unit-name}-code-generation-plan.md`から完全な計画を読み取る
- [ ] 次の未完了ステップ（最初の[ ]チェックボックス）を識別
- [ ] そのステップのコンテキスト（ユニット、依存関係、ストーリー）を読み込む

## ステップ11：現在のステップを実行
- [ ] 計画からターゲットディレクトリを確認（決してaidlc-docs/ではない）
- [ ] **ブラウンフィールドのみ**：ターゲットファイルが存在するかチェック
- [ ] 現在のステップが説明していることを正確に生成：
  - **ファイルが存在する場合**：インプレースで変更（決して`ClassName_modified.java`、`ClassName_new.java`などを作成しない）
  - **ファイルが存在しない場合**：新しいファイルを作成
- [ ] 正しい場所に書き込む：
  - **アプリケーションコード**：プロジェクト構造ごとのワークスペースルート
  - **ドキュメント**：`aidlc-docs/construction/{unit-name}/code/`（markdownのみ）
  - **ビルド/設定ファイル**：ワークスペースルート
- [ ] ユニットストーリー要件に従う
- [ ] 依存関係とインターフェースを尊重

## ステップ12：進捗を更新
- [ ] ユニットコード生成計画で完了したステップを[x]としてマーク
- [ ] 生成が終了したら関連するユニットストーリーを[x]としてマーク
- [ ] `aidlc-docs/aidlc-state.md`の現在のステータスを更新
- [ ] **ブラウンフィールドのみ**：重複ファイルが作成されていないことを確認（例：`ClassName.java`と並んで`ClassName_modified.java`がない）
- [ ] 生成されたすべての成果物を保存

## ステップ13：生成を続行または完了
- [ ] さらにステップが残っている場合は、ステップ10に戻る
- [ ] すべてのステップが完了した場合は、完了メッセージの提示に進む

## ステップ14：完了メッセージを提示
- この構造で完了メッセージを提示：
     1. **完了アナウンス**（必須）：常にこれで始める：

```markdown
# 💻 コード生成完了 - [unit-name]
```

     2. **AIサマリー**（オプション）：構造化された箇条書きサマリーを提供
        - **ブラウンフィールド**：変更されたファイルと作成されたファイルを区別（例：「• 変更：`src/services/user-service.ts`」、「• 作成：`src/services/auth-service.ts`」）
        - **グリーンフィールド**：パス付きで作成されたファイルをリスト（例：「• 作成：`src/services/user-service.ts`」）
        - パス付きでテスト、ドキュメント、デプロイメント成果物をリスト
        - 事実的に、ワークフロー指示なし
     3. **フォーマットされたワークフローメッセージ**（必須）：常にこの正確な形式で終わる：

```markdown
> **📋 <u>**確認が必要：**</u>**  
> 以下の生成されたコードを確認してください：
> - **アプリケーションコード**：`[actual-workspace-path]`
> - **ドキュメント**：`aidlc-docs/construction/[unit-name]/code/`



> **🚀 <u>**次は何ですか？**</u>**
>
> **以下を行うことができます：**
>
> 🔧 **変更を要求** - 確認に基づいて生成されたコードへの変更を依頼
> ✅ **次のステージに続行** - コード生成を承認して**[next-unit/Build & Test]**に進む

---
```

## ステップ15：明示的な承認を待つ
- ユーザーが生成されたコードを明示的に承認するまで進まない
- 承認は明確で曖昧さがない必要がある
- ユーザーが変更を要求した場合は、コードを更新して承認プロセスを繰り返す

## ステップ16：承認を記録して進捗を更新
- タイムスタンプ付きでaudit.mdに承認を記録
- タイムスタンプ付きでユーザーの承認応答を記録
- aidlc-state.mdでこのユニットのコード生成ステージを完了としてマーク

---

## 重要なルール

### コード配置ルール
- **アプリケーションコード**：ワークスペースルートのみ（決してaidlc-docs/ではない）
- **ドキュメント**：aidlc-docs/のみ（markdownサマリー）
- コード生成前にaidlc-state.mdから**ワークスペースルートを読み取る**

**プロジェクトタイプごとの構造パターン**：
- **ブラウンフィールド**：既存の構造を使用（例：`src/main/java/`、`lib/`、`pkg/`）
- **グリーンフィールド単一ユニット**：ワークスペースルートに`src/`、`tests/`、`config/`
- **グリーンフィールドマルチユニット（マイクロサービス）**：`{unit-name}/src/`、`{unit-name}/tests/`
- **グリーンフィールドマルチユニット（モノリス）**：`src/{unit-name}/`、`tests/{unit-name}/`

### ブラウンフィールドファイル変更ルール
- 生成前にファイルが存在するかチェック
- 存在する場合：インプレースで変更（決して`ClassName_modified.java`のようなコピーを作成しない）
- 存在しない場合：新しいファイルを作成
- 生成後に重複ファイルがないことを確認（ステップ12）

### 計画フェーズのルール
- すべての生成アクティビティのための明示的な番号付きステップを作成
- 計画にストーリーのトレーサビリティを含める
- ユニットのコンテキストと依存関係を文書化
- 生成前に明示的なユーザー承認を取得

### 生成フェーズのルール
- **ハードコードされたロジックなし**：ユニット計画に書かれていることのみを実行
- **計画に正確に従う**：ステップシーケンスから逸脱しない
- **チェックボックスを更新**：各ステップを完了した直後に[x]をマーク
- **ストーリーのトレーサビリティ**：機能が実装されたらユニットストーリーを[x]でマーク
- **依存関係を尊重**：ユニットの依存関係が満たされている場合にのみ実装

## 完了基準
- 完全なユニットコード生成計画が作成され、承認されている
- ユニットコード生成計画のすべてのステップが[x]でマークされている
- すべてのユニットストーリーが計画に従って実装されている
- すべてのコードとテストが生成されている（テストはビルド＆テストフェーズで実行される）
- デプロイメント成果物が生成されている
- 完全なユニットがビルドと検証の準備ができている
